version: "3.7"

services:
  ubuntu-base:
    build:
      context: .
      args:
        image_cookbook_dir: ./cookbook
        image_build_dir: ./build/ubuntu-base
      dockerfile: build/ubuntu-base/Dockerfile
    image: "ubuntu-base:latest"
    stdin_open: true
    tty: true

  traefik:
    build:
      context: .
      args:
        image_cookbook_dir: ./cookbook
        image_build_dir: ./build/traefik
        TRAEFIK_VERSION: 2.9.6
      dockerfile: build/traefik/Dockerfile
    image: "traefik:latest"
    environment:
      - TRAEFIK_CONFIG= default
    ports:
      - "80:80"
      - "443:443"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.dev`)"
      - "traefik.http.routers.api.service=api@internal"
      - "traefik.http.routers.traefik.tls=true"
    stdin_open: true
    tty: true


  service-deploy:
    build:
      context: .
      args:
        image_cookbook_dir: ./cookbook
        image_build_dir: ./build/service-deploy
        ANSIBLE_VERSION: 2.9
        PYTHON_VERSION: 3.9
        TERRAFORM_VERSION: 1.3.7
      dockerfile: build/service-deploy/Dockerfile
    image: "service-deploy:latest"
    hostname: service-deploy
    container_name: service-deploy
    stdin_open: true
    tty: true

  varnish:
    build:
      context: .
      args:
        image_cookbook_dir: ./cookbook
        image_build_dir: ./build/varnish
      dockerfile: build/varnish/Dockerfile
    image: "varnish:latest"
    environment:
      - VARNISH_CONFIG=default
    stdin_open: true
    tty: true

  zabbix:
    build:
      context: .
      args:
        image_cookbook_dir: ./cookbook
        image_build_dir: ./build/zabbix
        ZABBIX_VERSION: 6.0.4
        MYSQL_VERSION: 7.4
      dockerfile: build/varnish/Dockerfile
    image: "zabbix:latest"
#    labels:
#      - "traefik.enable=true"
#      - "traefik.http.routers.zabbix.rule=Host(`zabbix.dev`)"
#      - "traefik.http.routers.zabbix.service=zabbix"
#      - "traefik.http.routers.zabbix.tls=true"
#      - "traefik.http.services.zabbix.loadbalancer.server.port=80"
    stdin_open: true
    tty: true

  rabbitmq:
    build:
      context: .
      args:
        image_cookbook_dir: ./cookbook
        image_build_dir: ./build/rabbbitmq
      dockerfile: build/rabbitmq/Dockerfile
    image: "rabbitmq:latest"
    ports:
      - "5672:5672"
      - "15672:15672"
      - "25672:25672"
#    labels:
#      - "traefik.enable=true"
#      - "traefik.http.routers.rabbitmq.rule=Host(`rabbitmq.dev`)"
#      - "traefik.http.routers.rabbitmq.service=rabbitmq"
#      - "traefik.http.routers.rabbitmq.tls=true"
#      - "traefik.http.services.rabbitmq.loadbalancer.server.port=15672"
    stdin_open: true
    tty: true

  docker-registry:
    restart: always
    image: registry:2
    ports:
      - 5000:5000
#    environment:
#      REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain.crt
#      REGISTRY_HTTP_TLS_KEY: /certs/domain.key
#      REGISTRY_AUTH: htpasswd
#      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
#      REGISTRY_AUTH_HTPASSWD_REALM: Registry Realm
    volumes:
      - /<path_to_registry>:/var/lib/registry
#      - /path/certs:/certs
#      - /path/auth:/auth